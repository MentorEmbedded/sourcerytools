#include <pthread.h>
#include <pthread_exception.h>
#include <stdio.h>

void *
tf (void *p)
{
  int c = 0;
  while (1)
    {
      TRY
        {
          ++c;
          if (c == 100)
            pthread_exit (NULL);
          else if (c == 200)
            abort ();
          write (1, ".", 1);
        }
      CATCH_ALL
        {
          write (1, "caught\n", 7);
        }
      ENDTRY
    }

  return NULL;
}

int
main (void)
{
  pthread_t t;
  while (1)
    {
      write (1, "creating\n", sizeof("creating\n")-1);
      if (pthread_create (&t, NULL, tf, NULL))
        break;
      if (pthread_cancel (t))
        break;
      if (pthread_join (t, NULL))
        break;
      break;
    }
  return 1;
}

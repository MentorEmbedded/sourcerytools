<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;3.2//EN&quot;&gt;<br>
&lt;HTML&gt;<br>
&lt;HEAD&gt;<br>
&lt;META&nbsp;HTTP-EQUIV=&quot;Content-Type&quot;&nbsp;CONTENT=&quot;text/html;&nbsp;charset=us-ascii&quot;&gt;<br>
&lt;META&nbsp;NAME=&quot;Generator&quot;&nbsp;CONTENT=&quot;MS&nbsp;Exchange&nbsp;Server&nbsp;version&nbsp;6.5.6944.0&quot;&gt;<br>
&lt;TITLE&gt;Complete&nbsp;fix&nbsp;to&nbsp;cancellation/stack&nbsp;unwinding&nbsp;problem&nbsp;of&nbsp;deferred&nbsp;Posix&nbsp;threads&lt;/TITLE&gt;<br>
&lt;/HEAD&gt;<br>
&lt;BODY&gt;<br>
&lt;!--&nbsp;Converted&nbsp;from&nbsp;text/rtf&nbsp;format&nbsp;--&gt;<br>
<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;Before&nbsp;going&nbsp;into&nbsp;specifics&nbsp;I&nbsp;post&nbsp;the&nbsp;question:&lt;U&gt;&lt;/U&gt;&lt;/FONT&gt;&lt;U&gt;&lt;/U&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;U&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;Are&nbsp;there&nbsp;plans&nbsp;to&nbsp;fix&lt;/FONT&gt;&nbsp;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;terminal&nbsp;bugs&nbsp;with&lt;/FONT&gt;&nbsp;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;cancellation/stack&nbsp;unwinding&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;of&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;deferred&nbsp;Posix&nbsp;threads?&lt;/FONT&gt;&lt;/U&gt;&lt;/SPAN&gt;<br>
&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;My&nbsp;test&nbsp;program&nbsp;attempted&nbsp;to&nbsp;cancel&nbsp;deferred&nbsp;thread&nbsp;whose&nbsp;cancellation&nbsp;state&nbsp;is&nbsp;enabled&nbsp;before&nbsp;call&nbsp;to&nbsp;pthread_canceltest&nbsp;and&nbsp;is&nbsp;disabled&nbsp;immediately&nbsp;afterwards.&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;When&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;such&nbsp;thread&nbsp;is&nbsp;being&nbsp;cancelled&nbsp;on&nbsp;2.4&nbsp;kernel&nbsp;with&nbsp;gcc&nbsp;3.2.3&lt;/FONT&gt;&nbsp;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;the&nbsp;test&nbsp;program&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;crash&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;es&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;with&nbsp;'FATAL:&nbsp;exception&nbsp;not&nbsp;rethrown'&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;.&nbsp;Rethrowing&nbsp;system&nbsp;(catch&nbsp;&#8230;)&nbsp;exception&nbsp;made&nbsp;no&nbsp;difference.&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;Same&nbsp;test&nbsp;program&nbsp;does&nbsp;not&nbsp;crash&nbsp;when&nbsp;build&nbsp;and&nbsp;run&nbsp;on&nbsp;2.6&nbsp;kernel&lt;/FONT&gt;&nbsp;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;with&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;gcc&nbsp;3.3.3&nbsp;but&lt;/FONT&gt;&nbsp;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;instead&nbsp;it&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;deadlocks&nbsp;with&nbsp;corrupted&nbsp;stack&nbsp;soon&nbsp;(&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;~&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;2&nbsp;sec)&nbsp;after&nbsp;call&nbsp;to&nbsp;pthread_cancel:&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;<br>
&lt;UL&gt;<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;(gdb)&nbsp;where&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#0&nbsp;&nbsp;0xffffe415&nbsp;in&nbsp;??&nbsp;()&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#1&nbsp;&nbsp;0xbfffdf2c&nbsp;in&nbsp;??&nbsp;()&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#2&nbsp;&nbsp;0x00000002&nbsp;in&nbsp;??&nbsp;()&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#3&nbsp;&nbsp;0x00000000&nbsp;in&nbsp;??&nbsp;()&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#4&nbsp;&nbsp;0x4035ebfe&nbsp;in&nbsp;__lll_mutex_lock_wait&nbsp;()&nbsp;from&nbsp;/lib/tls/libpthread.so.0&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#5&nbsp;&nbsp;0x4035bc00&nbsp;in&nbsp;_L_mutex_lock_33&nbsp;()&nbsp;from&nbsp;/lib/tls/libpthread.so.0&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#6&nbsp;&nbsp;0x00001000&nbsp;in&nbsp;??&nbsp;()&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#7&nbsp;&nbsp;0x40349bd0&nbsp;in&nbsp;__elf_set___libc_thread_subfreeres_element___rpc_thread_destroy__&nbsp;()&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;&nbsp;&nbsp;from&nbsp;/lib/tls/libc.so.6&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#8&nbsp;&nbsp;0x40c62360&nbsp;in&nbsp;??&nbsp;()&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#9&nbsp;&nbsp;0xbfffe454&nbsp;in&nbsp;??&nbsp;()&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#10&nbsp;0xbfffdfa4&nbsp;in&nbsp;??&nbsp;()&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;#11&nbsp;0x40c669f9&nbsp;in&nbsp;_nss_files_gethostbyname_r&nbsp;()&nbsp;from&nbsp;/lib/libnss_files.so.2&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;Previous&nbsp;frame&nbsp;identical&nbsp;to&nbsp;this&nbsp;frame&nbsp;(corrupt&nbsp;stack?)&lt;/FONT&gt;&lt;/SPAN&gt;<br>
&lt;/UL&gt;<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;I&lt;/FONT&gt;&nbsp;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;see&nbsp;two&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;problem&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;s:&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;1)&nbsp;pthread_cancel()&nbsp;cancels&nbsp;thread&nbsp;before&nbsp;reaching&nbsp;cancellation&nbsp;point&nbsp;in&nbsp;pthread_testcancel()&lt;/FONT&gt;&lt;/SPAN&gt;<br>
<br>
&lt;BR&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;2)&nbsp;stack&nbsp;gets&nbsp;corrupted&nbsp;during&nbsp;unwind.&lt;/FONT&gt;&lt;/SPAN&gt;<br>
&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;Since&nbsp;the&nbsp;behavior&nbsp;changed,&nbsp;-&nbsp;from&nbsp;crash&nbsp;to&nbsp;deadlock&nbsp;(an&nbsp;improvement&nbsp;in&nbsp;a&nbsp;way&nbsp;:),&nbsp;-&nbsp;I&nbsp;want&nbsp;to&nbsp;ask&nbsp;what&nbsp;thread&nbsp;cancellation&nbsp;bugs&nbsp;were&nbsp;fixed&lt;/FONT&gt;&nbsp;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;on&nbsp;2.6&nbsp;kernel&lt;/FONT&gt;&nbsp;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;+&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;gcc&nbsp;3.3.3&lt;/FONT&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;,&nbsp;and,&nbsp;more&nbsp;importantly,&nbsp;when&nbsp;the&nbsp;patch&nbsp;with&nbsp;complete&nbsp;fix&nbsp;(no&nbsp;stack&nbsp;corruption,&nbsp;no&nbsp;crash)&nbsp;will&nbsp;become&nbsp;available.&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;I&nbsp;realize&nbsp;that&nbsp;the&nbsp;above&nbsp;details&nbsp;should&nbsp;be&nbsp;posted&nbsp;on&nbsp;bugzilla&nbsp;but&nbsp;wanted&nbsp;to&nbsp;asked&nbsp;my&nbsp;question&nbsp;here.&nbsp;I&nbsp;was&nbsp;referred&nbsp;to&nbsp;this&nbsp;list&nbsp;by&nbsp;an&nbsp;owner&nbsp;of&nbsp;bug&nbsp;111548&nbsp;who&nbsp;indicated&nbsp;that&nbsp;the&nbsp;decision&nbsp;of&nbsp;when&nbsp;and&nbsp;if&nbsp;the&nbsp;fix&nbsp;will&nbsp;be&nbsp;made&nbsp;rests&nbsp;with&nbsp;some&nbsp;members&nbsp;of&nbsp;C++-pthreads:&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;/SPAN&gt;&lt;A&nbsp;HREF=&quot;http://bugzilla.redhat.com/bugzilla/long_list.cgi?buglist=111548&quot;&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;U&gt;&lt;FONT&nbsp;COLOR=&quot;#0000FF&quot;&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;http://bugzilla.redhat.com/bugzilla/long_list.cgi?buglist=111548&lt;/FONT&gt;&lt;/U&gt;&lt;/SPAN&gt;&lt;/A&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;/SPAN&gt;<br>
&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;It&nbsp;is&nbsp;pity&nbsp;that&nbsp;so&nbsp;complete&nbsp;pthreads&nbsp;implementation&nbsp;is&nbsp;not&nbsp;fully&nbsp;usable&nbsp;in&nbsp;spite&nbsp;the&nbsp;fact&nbsp;that&nbsp;thread&nbsp;cancellation/stack&nbsp;unwinding&nbsp;problems&nbsp;are&nbsp;known&nbsp;for&nbsp;some&nbsp;time&nbsp;(I've&nbsp;read&nbsp;relevant&nbsp;discussion&nbsp;threads&nbsp;of&nbsp;this&nbsp;group).&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;SPAN&nbsp;LANG=&quot;en-us&quot;&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/FONT&gt;&nbsp;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;George&lt;/FONT&gt;&lt;/SPAN&gt;<br>
&lt;/P&gt;<br>
<br>
&lt;/BODY&gt;<br>
&lt;/HTML&gt;
</tt>

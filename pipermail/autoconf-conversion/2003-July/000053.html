<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> Toplevel configury, multilibs, new autoconf versions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:autoconf-conversion%40codesourcery.com?Subject=Re%3A%20Toplevel%20configury%2C%20multilibs%2C%20new%20autoconf%20versions&In-Reply-To=%3C20030727233313.GA23583%40disaster.jaj.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000052.html">
   <LINK REL="Next"  HREF="000054.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>Toplevel configury, multilibs, new autoconf versions</H1>
    <B>Phil Edwards</B> 
    <A HREF="mailto:autoconf-conversion%40codesourcery.com?Subject=Re%3A%20Toplevel%20configury%2C%20multilibs%2C%20new%20autoconf%20versions&In-Reply-To=%3C20030727233313.GA23583%40disaster.jaj.com%3E"
       TITLE="Toplevel configury, multilibs, new autoconf versions">phil at jaj.com
       </A><BR>
    <I>Sun Jul 27 23:33:13 UTC 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="000052.html">[autoconf-conversion] New tools and multilibs fight with one another
</A></li>
        <LI>Next message: <A HREF="000054.html">[autoconf-conversion] Re: Toplevel configury, multilibs, new autoconf versions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53">[ date ]</a>
              <a href="thread.html#53">[ thread ]</a>
              <a href="subject.html#53">[ subject ]</a>
              <a href="author.html#53">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sat, Jul 26, 2003 at 04:58:55PM -0400, Phil Edwards wrote:
&gt;<i> &gt; &gt;    libstdcxx_flags='`test ! -f 
</I>&gt;<i> &gt; &gt;$$r/$(TARGET_SUBDIR)/libstdc++-v3/scripts/testsuite_flags || $(SHELL) 
</I>&gt;<i> &gt; &gt;$$r/$(TARGET_SUBDIR)/libstdc++-v3/scripts/testsuite_flags 
</I>&gt;<i> &gt; &gt;--build-includes` -L$$r/$(TARGET_SUBDIR)/libstdc++-v3/src 
</I>&gt;<i> &gt; &gt;-L$$r/$(TARGET_SUBDIR)/libstdc++-v3/src/.libs'
</I>&gt;<i> &gt; &gt;    raw_libstdcxx_flags=' -L$$r/$(TARGET_SUBDIR)/libstdc++-v3/src 
</I>&gt;<i> &gt; &gt;-L$$r/$(TARGET_SUBDIR)/libstdc++-v3/src/.libs'
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;Note the -L options; these get embedded into CXX_FOR_TARGET a few lines
</I>&gt;<i> &gt; &gt;later, which becomes CXX inside the library.
</I>[...]
&gt;<i> Also, I'm having trouble understanding how this manages to work at present,
</I>&gt;<i> i.e., with the &quot;old&quot; autotools.  The -L options are still hardcoded
</I>&gt;<i> either way.
</I>
Okay, I've figured this part out, and why it's breaking.  I'm going to
need some help to make this work.

To make things clearer in this email, I'm going to pretend that the CXX
variable for a normal primary build is set to Primary.  (It's actully a long
&quot;..../xgcc -B... -L...&quot; string.)  So, when the primary v3 configure is run,
the toplevel does it via

    CXX=Primary $srcdir/configure --stuff

Clear?

Now, at the end of that run, config.status is generated and executed.
It source's config-ml.in, which runs through the list of multilib subdirs,
and does text substitution on the env variables.  Pretend we have one
multilib, and I'll call the CXX variable for that one Multilib:

    # config-ml.in does this
    Multilib=`echo Primary | sed 's/references-to-primary-dir/references-to-multilib-dir'`

    cd up-and-over-to-multilib-dir/libstdc++-v3
    CXX=Multilib $srcdir/configure --stuff

Where &quot;--stuff&quot; is everything that was passed to configure.  This list of
args is stored in config.status.  Remember that for later.

That's why hardcoding things like -L into CXX at the top level still work
for multilibs.  Still clear?


Since the days of autoconf 2.13, it has been obverved that people try to
do things like this, in general:

    $ CC=foo ./configure
    $ make
        [something breaks, requiring a reconfigure]
    $ ./configure
        [oops, CC wasn't set this time, different compilers are found
        during the tests, hilarity ensues]

To protect the users from themselves, autoconf 2.5x takes note of &quot;precious&quot;
variables in the environment, and remembers them.

    $ CC=foo ./configure
    $ make
        [something breaks, requiring a reconfigure]
    $ ./configure
    configure: error: you're being a dumbass!

To be both safe and helpful, the configure script actually stores those
variables into the generated config.status file -- pay attention now --
as if they had been specified on the command line.  The shell variable
which stores command-line arguments is augmented with those &quot;precious&quot;
environment variables.


So when a multilib run is fired off with configure generated by 2.57,
the created primary config.status source's config-ml.in, which then does
this just as before:

    Multilib=`echo Primary | sed '.....'`

    CXX=Multilib $srcdir/configure --stuff 'CXX=Primary'

When configure examines the command line and sees variable assignments,
it performs them without examining the current environment.  It does this
for safety, because it thinks the user is rerunning configure.

That sound you hear is configure wailing, &quot;MY PRECIOUSSSSSSSS!&quot; as it
overwrites Multilib with Primary.


I've made a couple of half-hearted attempts to defeat this from within
libstdc++'s acinclude.m4, but autoconf is too smart for me.


Phil

-- 
If ye love wealth greater than liberty, the tranquility of servitude greater
than the animating contest for freedom, go home and leave us in peace.  We seek
not your counsel, nor your arms.  Crouch down and lick the hand that feeds you;
and may posterity forget that ye were our countrymen.            - Samuel Adams

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000052.html">[autoconf-conversion] New tools and multilibs fight with one another
</A></li>
	<LI>Next message: <A HREF="000054.html">[autoconf-conversion] Re: Toplevel configury, multilibs, new autoconf versions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53">[ date ]</a>
              <a href="thread.html#53">[ thread ]</a>
              <a href="subject.html#53">[ subject ]</a>
              <a href="author.html#53">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://sourcerytools.com/cgi-bin/mailman/listinfo/autoconf-conversion">More information about the autoconf-conversion
mailing list</a><br>
</body></html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [PATCH] Introduce autoconf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:pooma-dev%40codesourcery.com?Subject=Re%3A%20%5BPATCH%5D%20Introduce%20autoconf&In-Reply-To=%3CPine.LNX.4.44.0301102243010.524-100000%40goofy%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001143.html">
   <LINK REL="Next"  HREF="001145.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[PATCH] Introduce autoconf</H1>
    <B>Richard Guenther</B> 
    <A HREF="mailto:pooma-dev%40codesourcery.com?Subject=Re%3A%20%5BPATCH%5D%20Introduce%20autoconf&In-Reply-To=%3CPine.LNX.4.44.0301102243010.524-100000%40goofy%3E"
       TITLE="[PATCH] Introduce autoconf">rguenth at tat.physik.uni-tuebingen.de
       </A><BR>
    <I>Fri Jan 10 21:52:34 UTC 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="001143.html">[pooma-dev] [PATCH] Detect correct make command in configure
</A></li>
        <LI>Next message: <A HREF="001145.html">[PATCH] Introduce autoconf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1144">[ date ]</a>
              <a href="thread.html#1144">[ thread ]</a>
              <a href="subject.html#1144">[ subject ]</a>
              <a href="author.html#1144">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

The following patch is a further reduced introduction of autoconfisciation
of parts of the configuration process. It introduces scripts/configure.ac
(and scripts/configure, if autogenerated files should be in CVS) and
changes the toplevel configure script to write the suite file, the
makefile stub and the pooma configuration header as .in file and pass it
down through a autoconf configure script.

For now some of the compiler feature bits are checked and substituted in
the pooma configuration header.

Tested by configuring and installing on ia32-gnu-linux and configuring
on HP-UX (aCC sucks) and IRIX (CC sucks, too).

Ok?

Richard.


2002Jan10  Richard Guenther &lt;<A HREF="http://sourcerytools.com/cgi-bin/mailman/listinfo/pooma-dev">richard.guenther at uni-tuebingen.de</A>&gt;

	* scripts/configure.ac: new.
	configure: generate lib/$suite/suite.mk.in,
	lib/$suite/Makefile.pooma.in and
	lib/$suite/PoomaConfiguration.h.in and from them generate using
	scripts/configure autoconf script the config/$suite.suite.mk,
	lib/$suite/Makefile.pooma-EXT and lib/$suite/PoomaConfiguration.h
	files. Use scripts/configure to check for compiler feature bits.

Index: configure
===================================================================
RCS file: /home/pooma/Repository/r2/configure,v
retrieving revision 1.107
diff -u -u -r1.107 configure
--- configure	8 Jan 2003 23:18:47 -0000	1.107
+++ configure	10 Jan 2003 21:41:33 -0000
@@ -101,7 +101,7 @@
 ###########################################################################

 ### the name of the make program - gmake if available, else make
-if ( system(&quot;gmake README&quot;) == 0 )
+if ( system(&quot;gmake -v &gt;/dev/null 2&gt;&amp;1&quot;) == 0 )
   {
      $makecmd         = gmake;
   }
@@ -548,6 +548,9 @@
 ### list of defines that should be surrounded by #ifndef checks
 @protecteddeflist = ();

+### list of autoconfigured #define statements in header
<A HREF="http://sourcerytools.com/cgi-bin/mailman/listinfo/pooma-dev">+ at autoconfdeflist</A> = ();
+
 ### list of -D define statements that should go with each compilation
 $defines = &quot;&quot;;

@@ -669,6 +672,20 @@
 }


+### adds a define stub that gets substituted by autoconf
+sub add_autoconf_define
+{
+  my ($argstring) = @_;
+  if (not $argstring)
+    {
+      die &quot;Error in add_yesno_define: must supply one arguments.\n&quot;;
+    }
+  $argstring .= &quot;=\@$argstring\@&quot;;
+  print &quot;  Adding autoconf define string = $argstring.\n&quot; if $dbgprnt;
+  push @autoconfdeflist, $argstring;
+}
+
+
 ### if the second argument is true, add a define to our list of the form
 ### FIRSTARG=POOMA_YES; otherwise, add it as FIRSTARG=POOMA_NO
 ### Same as add_yesno_define, except protected
@@ -829,6 +846,11 @@
   if (scalar @{$arghash{$cppnm}} &gt; 1)
     {
       $cpp = $arghash{$cppnm}[1];
+      # if no link cmd is specified, use $cpp
+      if (scalar @{$arghash{$linknm}} == 0)
+        {
+          $link = $cpp;
+        }
     }
   else
     {
@@ -882,7 +904,7 @@
     {
       $arargs .= &quot; $arghash{$arargnm}[$i]&quot;;
     }
-  for $i (2 .. $#{$arghash{$linkargnm}})
+  for $i (1 .. $#{$arghash{$linkargnm}})
     {
       $linkargs .= &quot; $arghash{$linkargnm}[$i]&quot;;
     }
@@ -1703,12 +1725,10 @@
 sub setcharacteristics
 {
   # if the system does not have the stringstream class, must use workaround
-  add_yesno_define(&quot;POOMA_NO_STRINGSTREAM&quot;,
-		   $no_stringstream);
+  add_autoconf_define(&quot;POOMA_NO_STRINGSTREAM&quot;);

   # if the system is missing some of the iostream manipulators, must avoid them
-  add_yesno_define(&quot;POOMA_MISSING_IOMANIPS&quot;,
-		   $no_complete_iomanips);
+  add_autoconf_define(&quot;POOMA_MISSING_IOMANIPS&quot;);

   # if the C++ compiler does not allow templated friends, must say so
   add_yesno_define(&quot;POOMA_NO_TEMPLATE_FRIENDS&quot;,
@@ -1724,8 +1744,7 @@
 		   $no_ostream_iterator_1arg);

   # if the compiler does not allow definitions of placement delete operations
-  add_yesno_define(&quot;POOMA_NO_PLACEMENT_DELETE&quot;,
-		   $no_placement_delete);
+  add_autoconf_define(&quot;POOMA_NO_PLACEMENT_DELETE&quot;);

   # should we include extra specializations of some things for small dim?
   add_yesno_define(&quot;POOMA_SMALL_DIM_SPECIALIZATIONS&quot;,
@@ -1733,24 +1752,20 @@

   # if the C++ compiler does not allow template parameters to be dependent,
   # on others (e.g., template&lt;int D1, int D2=D1, ...&gt;,  must say so
-  add_yesno_define(&quot;POOMA_NO_DEPENDENT_TEMPLATE_ARGS&quot;,
-		   $no_dependent_templ_args);
+  add_autoconf_define(&quot;POOMA_NO_DEPENDENT_TEMPLATE_ARGS&quot;);

   # if the C++ library does not have templated complex number class, say so
-  add_yesno_define(&quot;POOMA_NO_TEMPLATED_COMPLEX&quot;,
-		   $no_templated_complex);
+  add_autoconf_define(&quot;POOMA_NO_TEMPLATED_COMPLEX&quot;);

   # if the C++ library does not have complex number class in std::, say so
-  add_yesno_define(&quot;POOMA_NO_STD_COMPLEX&quot;,
-		   $no_std_complex);
+  add_autoconf_define(&quot;POOMA_NO_STD_COMPLEX&quot;);

   # if the C++ library has O_BINARY defined
   add_yesno_define(&quot;POOMA_HAS_O_BINARY_OPEN_MODE&quot;,
                    $o_binary_open_mode);

   # if the C++ library does not have ios_base class in std::, say so
-  add_yesno_define(&quot;POOMA_NO_STD_IOSBASE&quot;,
-		   $no_std_iosbase);
+  add_autoconf_define(&quot;POOMA_NO_STD_IOSBASE&quot;);

   # if must include &lt;sys/stat.h&gt; for POSIX file modes, say so
   add_yesno_define(&quot;POOMA_INC_SYS_STAT_H_FOR_FILE_MODES&quot;,
@@ -1862,11 +1877,11 @@
   # put all the link options together
   my $totlibraries = &quot;$preliblist $midliblist $postliblist&quot;;
   my $liblinkargs=&quot;$linkshare $totlibraries&quot;;
-  my $totlinkargs = &quot;$linkargs $liblinkargs&quot;;
+  my $totlinkargs = &quot;$liblinkargs $linkargs&quot;;

   # open the suite file and write out a prefix
-  print &quot;Writing suite file $suitefile ...\n&quot;;
-  open(FSUITE,&quot;&gt;$suitefile&quot;) or die &quot;Cannot open $suitefile for write.\n&quot;;
+  print &quot;Writing suite file lib/$suite/suite.mk.in ...\n&quot;;
+  open(FSUITE,&quot;&gt;lib/$suite/suite.mk.in&quot;) or die &quot;Cannot open lib/$suite/suite.mk.in for write.\n&quot;;
   print FSUITE &quot;##########################################################\n&quot;;
   print FSUITE &quot;# POOMA suite file for suite: $suite\n&quot;;
   print FSUITE &quot;# Created $datestr by $userstr on $hoststr\n&quot;;
@@ -2089,8 +2104,8 @@
     }

   # open the output file, and write header
-  print &quot;Writing version info header file $vheader ...\n&quot;;
-  open(FHEADER,&quot;&gt;$vheader&quot;) or die &quot;Cannot open $vheader for write.\n&quot;;
+  print &quot;Writing version info header file $vheader.in ...\n&quot;;
+  open(FHEADER,&quot;&gt;$vheader.in&quot;) or die &quot;Cannot open $vheader.in for write.\n&quot;;
   print FHEADER &quot;/*******************************************************\n&quot;;
   print FHEADER &quot; * POOMA version information file for suite: $suite\n&quot;;
   print FHEADER &quot; * Created $datestr by $userstr on $hoststr\n&quot;;
@@ -2120,6 +2135,14 @@
       my $spaces = length $symbol;
       $maxmacrolen = $spaces + 1 if $spaces &gt;= $maxmacrolen;
     }
+  foreach $d (@autoconfdeflist)
+    {
+      my $symbol = &quot;&quot;;
+      my $value  = &quot;&quot;;
+      ($symbol, $value) = split /=/, $d, 2;
+      my $spaces = length $symbol;
+      $maxmacrolen = $spaces + 1 if $spaces &gt;= $maxmacrolen;
+    }

   foreach $d (@deflist)
     {
@@ -2142,6 +2165,16 @@
       print FHEADER &quot;#endif\n\n&quot;;
     }

+  foreach $d (@autoconfdeflist)
+    {
+      my $symbol = &quot;&quot;;
+      my $value  = &quot;&quot;;
+      ($symbol, $value) = split /=/, $d, 2;
+      my $spaces = $maxmacrolen - (length $symbol);
+      print FHEADER &quot;#define $symbol&quot; . &quot; &quot; x $spaces . &quot;$value\n&quot;;
+    }
+  print FHEADER &quot;\n&quot;;
+
   # finished writing header file
   print FHEADER &quot;#endif\n&quot;;
   print FHEADER &quot;\n&quot;;
@@ -2203,7 +2236,7 @@
     }

   # put all the link options together
-  my $totlinkargs = &quot;$linkargs $linkshare $preliblist $midliblist $postliblist&quot;;
+  my $totlinkargs = &quot;$linkshare $preliblist $midliblist $postliblist $linkargs&quot;;

   # put all the includes together
   my $totinclist = &quot;-I\$(POOMA_LIBDIR)/$versionheaderbase$extensions $inclist&quot;;
@@ -2212,8 +2245,8 @@
   my $totdefines = &quot;$defines&quot;;

   # open the makefile stub file and write out a prefix
-  print &quot;Writing makefile stub $mfile ...\n&quot;;
-  open(MFILE,&quot;&gt;$mfile&quot;) or die &quot;Cannot open $mfile for write.\n&quot;;
+  print &quot;Writing makefile stub lib/$suite/$makefilestub.in ...\n&quot;;
+  open(MFILE,&quot;&gt;lib/$suite/$makefilestub.in&quot;) or die &quot;Cannot open lib/$suite/$makefilestub.in for write.\n&quot;;
   print MFILE &quot;##########################################################\n&quot;;
   print MFILE &quot;# POOMA application makefile stub for suite: $suite\n&quot;;
   print MFILE &quot;# Created $datestr by $userstr on $hoststr\n&quot;;
@@ -2323,6 +2356,23 @@
   close MFILE;
 }

+sub runautoconf
+{
+  # change to libdir, remove autoconf cache
+  chdir(&quot;lib/$suite&quot;);
+  unlink(&quot;config.cache&quot;);
+
+  # run configure
+  system(&quot;env CXX=$cpp CXXFLAGS=\&quot;$cppargs\&quot; ../../scripts/configure&quot;) == 0
+    or die &quot;Autoconf configuration failed: $?\n&quot;;
+
+  # move generated files to their place
+  system(&quot;mv -f suite.mk ../../$suitefile&quot;);
+  system(&quot;mv -f Makefile.pooma $makefilestub$extensions&quot;);
+
+  # go back
+  chdir(&quot;../../&quot;);
+}

 ###########################################################################
 #
@@ -2403,8 +2453,10 @@
 setshared;                      # figure out if a shared lib should be made
 setarchfns;                     # figure out if we enable arch-specific init fns

-### write out the suite file, and run 'make dirs' to create the directory
-### where the header file will go
+### create the lib dir to write the following stuff to
+system(&quot;mkdir -p lib/$suite&quot;);
+
+### write out the suite file
 writesuitefile;

 ### write out the header file with versions information, in the lib dir
@@ -2412,6 +2464,12 @@

 ### write out a makefile stub that other users can include, in the lib dir
 writemakestub;
+
+### run autoconfiguration part
+runautoconf;
+
+### create remaining dirs
+system(&quot;$makecmd dirs SUITE=$suite&quot;);

 ### create dependencies
 writedependfile;
--- /dev/null	2002-12-29 19:08:32.000000000 +0100
+++ scripts/configure.ac	2003-01-10 21:57:10.000000000 +0100
@@ -0,0 +1,188 @@
+AC_INIT(pooma, 2.4.0)
+
+AC_ARG_VAR(CXX, [C++ compiler])
+AC_ARG_VAR(CXXFLAGS, [C++ compiler flags])
+
+AC_PROG_CXX
+AC_PROG_CXXCPP
+
+
+AC_LANG_CPLUSPLUS
+
+dnl
+dnl check for IO manipulators
+dnl
+AC_MSG_CHECKING([wether we have complete IO manipulators])
+AC_TRY_COMPILE([
+#include &lt;iostream&gt;
+#include &lt;iomanip&gt;
+], [
+	std::cout &lt;&lt; std::left;
+], [
+AC_MSG_RESULT([yes])
+POOMA_MISSING_IOMANIPS=POOMA_NO
+] , [
+AC_MSG_RESULT([no])
+POOMA_MISSING_IOMANIPS=POOMA_YES
+])
+AC_SUBST(POOMA_MISSING_IOMANIPS)
+
+dnl
+dnl check for std iosbase
+dnl
+AC_MSG_CHECKING([wether we have a standard iosbase class])
+AC_TRY_COMPILE([
+#include &lt;iostream&gt;
+#include &lt;iomanip&gt;
+class Inform;
+inline Inform &amp;operator&lt;&lt;(Inform &amp;o, std::ios_base &amp;(*d)(std::ios_base &amp;))
+{
+}
+], [
+], [
+AC_MSG_RESULT([yes])
+POOMA_NO_STD_IOSBASE=POOMA_NO
+] , [
+AC_MSG_RESULT([no])
+POOMA_NO_STD_IOSBASE=POOMA_YES
+])
+AC_SUBST(POOMA_NO_STD_IOSBASE)
+
+dnl
+dnl check for stringstream
+dnl
+AC_MSG_CHECKING([wether we have sstream])
+AC_TRY_COMPILE([
+#include &lt;sstream&gt;
+], [
+	std::ostringstream *msg;
+], [
+AC_MSG_RESULT([yes])
+POOMA_NO_STRINGSTREAM=POOMA_NO
+] , [
+AC_MSG_RESULT([no])
+POOMA_NO_STRINGSTREAM=POOMA_YES
+])
+AC_SUBST(POOMA_NO_STRINGSTREAM)
+
+dnl
+dnl check for complex in std and templated complex
+dnl
+AC_MSG_CHECKING([wether we have a complex inside std])
+AC_TRY_COMPILE([
+#include &lt;complex&gt;
+], [
+	std::complex&lt;double&gt; val;
+], [
+complexok=yes
+AC_MSG_RESULT([yes])
+POOMA_NO_STD_COMPLEX=POOMA_NO
+] , [
+AC_MSG_RESULT([no])
+POOMA_NO_STD_COMPLEX=POOMA_YES
+])
+POOMA_NO_TEMPLATED_COMPLEX=POOMA_NO
+if test x$complexok != xyes; then
+  AC_MSG_CHECKING([wether we have a not-templated complex])
+  AC_TRY_COMPILE([
+  #include &lt;complex&gt;
+  ], [
+	complex&lt;double&gt; val;
+  ], [
+  AC_MSG_RESULT([no])
+  ] , [
+  AC_MSG_RESULT([yes])
+  POOMA_NO_TEMPLATED_COMPLEX=POOMA_YES
+  ])
+fi
+AC_SUBST(POOMA_NO_STD_COMPLEX)
+AC_SUBST(POOMA_NO_TEMPLATED_COMPLEX)
+
+dnl
+dnl check for dependent template arguments
+dnl
+AC_MSG_CHECKING([wether we support dependent template arguments])
+AC_TRY_COMPILE([
+template &lt;int D1, int D2&gt;
+class Foo;
+template &lt;int D1, int D2=D1&gt;
+class Foo {
+};
+], [
+], [
+AC_MSG_RESULT([yes])
+POOMA_NO_DEPENDENT_TEMPLATE_ARGS=POOMA_NO
+] , [
+AC_MSG_RESULT([no])
+POOMA_NO_DEPENDENT_TEMPLATE_ARGS=POOMA_YES
+])
+AC_SUBST(POOMA_NO_DEPENDENT_TEMPLATE_ARGS)
+
+dnl
+dnl check for placement delete operator support
+dnl
+AC_MSG_CHECKING([wether we support delete operators with placement argument])
+AC_TRY_COMPILE([
+class foo {
+	void operator delete(void *, void *) { }
+};
+], [
+], [
+AC_MSG_RESULT([yes])
+POOMA_NO_PLACEMENT_DELETE=POOMA_NO
+] , [
+AC_MSG_RESULT([no])
+POOMA_NO_PLACEMENT_DELETE=POOMA_YES
+])
+AC_SUBST(POOMA_NO_PLACEMENT_DELETE)
+
+dnl
+dnl check for correct handling of default arguments to specialized
+dnl template functions
+dnl
+AC_MSG_CHECKING([wether we handle default args to template functions correct])
+AC_TRY_COMPILE([
+template &lt;int Dim&gt;
+class Centering {};
+template &lt;int Dim&gt;
+const Centering&lt;Dim&gt; test(int a, int b = 0);
+template &lt;&gt;
+const Centering&lt;1&gt; test&lt;1&gt;(int a, int b);
+], [
+	Centering&lt;1&gt; c = test&lt;1&gt;(1);
+], [
+AC_MSG_RESULT([yes])
+POOMA_NO_TEMPLATEFUNC_DEFAULTARGS=POOMA_NO
+] , [
+AC_MSG_RESULT([no])
+POOMA_NO_TEMPLATEFUNC_DEFAULTARGS=POOMA_YES
+])
+AC_SUBST(POOMA_NO_TEMPLATEFUNC_DEFAULTARGS)
+
+dnl
+dnl check for ios header, use iostream if not
+dnl
+AC_CHECK_HEADER([ios],
+  [POOMA_NO_IOS_HEADER=POOMA_NO],
+  [POOMA_NO_IOS_HEADER=POOMA_YES])
+AC_SUBST(POOMA_NO_IOS_HEADER)
+
+dnl
+dnl check for std::ios_base::fmtflags
+dnl
+AC_MSG_CHECKING([wether we have std::ios_base::fmtflags])
+AC_TRY_COMPILE([
+#include &lt;iostream&gt;
+typedef std::ios_base::fmtflags FmtFlags_t;
+], [
+	FmtFlags_t f;
+], [
+AC_MSG_RESULT([yes])
+POOMA_NO_IOSBASE_FMTFLAGS=POOMA_NO
+] , [
+AC_MSG_RESULT([no])
+POOMA_NO_IOSBASE_FMTFLAGS=POOMA_YES
+])
+AC_SUBST(POOMA_NO_IOSBASE_FMTFLAGS)
+
+AC_OUTPUT(PoomaConfiguration.h suite.mk Makefile.pooma)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001143.html">[pooma-dev] [PATCH] Detect correct make command in configure
</A></li>
	<LI>Next message: <A HREF="001145.html">[PATCH] Introduce autoconf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1144">[ date ]</a>
              <a href="thread.html#1144">[ thread ]</a>
              <a href="subject.html#1144">[ subject ]</a>
              <a href="author.html#1144">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://sourcerytools.com/cgi-bin/mailman/listinfo/pooma-dev">More information about the pooma-dev
mailing list</a><br>
</body></html>

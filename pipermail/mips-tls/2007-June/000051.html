<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mips-tls] DTPREL relocations in input files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mips-tls%40codesourcery.com?Subject=Re%3A%20%5Bmips-tls%5D%20DTPREL%20relocations%20in%20input%20files&In-Reply-To=%3C466826F0.6020706%40mips.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000050.html">
   <LINK REL="Next"  HREF="000052.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mips-tls] DTPREL relocations in input files</H1>
    <B>Nigel Stephens</B> 
    <A HREF="mailto:mips-tls%40codesourcery.com?Subject=Re%3A%20%5Bmips-tls%5D%20DTPREL%20relocations%20in%20input%20files&In-Reply-To=%3C466826F0.6020706%40mips.com%3E"
       TITLE="[mips-tls] DTPREL relocations in input files">nigel at mips.com
       </A><BR>
    <I>Thu Jun  7 15:40:32 UTC 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000050.html">DTPREL relocations in input files
</A></li>
        <LI>Next message: <A HREF="000052.html">[mips-tls] DTPREL relocations in input files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51">[ date ]</a>
              <a href="thread.html#51">[ thread ]</a>
              <a href="subject.html#51">[ subject ]</a>
              <a href="author.html#51">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

Joseph S. Myers wrote:
&gt;<i> The MIPS TLS specification has R_MIPS_TLS_DTPREL32 and R_MIPS_TLS_DTPREL64 
</I>&gt;<i> as relocations generated by the static linker and resolved by the dynamic 
</I>&gt;<i> linker.  (For those of you reading the document at 
</I>&gt;<i> &lt;<A HREF="http://www.linux-mips.org/wiki/NPTL">http://www.linux-mips.org/wiki/NPTL</A>&gt;, what appear there as 
</I>&gt;<i> R_MIPS_TLS_DTPOFF32 and R_MIPS_TLS_DTPOFF64 got renamed as part of merging 
</I>&gt;<i> the changes into FSF binutils, and the document hasn't been updated since 
</I>&gt;<i> then; see notes on changes at 
</I>&gt;<i> &lt;<A HREF="http://gcc.gnu.org/ml/gcc-patches/2005-03/msg00959.html">http://gcc.gnu.org/ml/gcc-patches/2005-03/msg00959.html</A>&gt;.)
</I>&gt;<i>
</I>&gt;<i> While there are DTP-relative relocations R_MIPS_TLS_DTPREL_HI16 and 
</I>&gt;<i> R_MIPS_TLS_DTPREL_LO16, used together to generate an offset for a 
</I>&gt;<i> thread-local variable, there is no single relocation representing the 
</I>&gt;<i> offset.  This causes problems generating debug information for such a 
</I>&gt;<i> variable; instead of
</I>&gt;<i>
</I>&gt;<i>   DW_OP_addr %dtprel(variable)
</I>&gt;<i>   DW_OP_GNU_push_tls_address
</I>&gt;<i>
</I>&gt;<i> much more complicated code is needed to describe the offset
</I>&gt;<i>
</I>&gt;<i>   DW_OP_addr %dtprel_hi(variable)
</I>&gt;<i>   DW_OP_addr %dtprel_lo(variable)
</I>&gt;<i>   DW_OP_const1u 16
</I>&gt;<i>   DW_OP_shl
</I>&gt;<i>   DW_OP_const1u 16
</I>&gt;<i>   DW_OP_shra
</I>&gt;<i>   DW_OP_swap
</I>&gt;<i>   DW_OP_const1u 16
</I>&gt;<i>   DW_OP_shl
</I>&gt;<i>   DW_OP_plus
</I>&gt;<i>   DW_OP_GNU_push_tls_address
</I>&gt;<i>
</I>&gt;<i> (for 32-bit, similar for 64-bit) - this does work and allow the debugger 
</I>&gt;<i> to use the variables, but is not very efficient.  It seems reasonable to 
</I>&gt;<i> allow R_MIPS_TLS_DTPREL32 and R_MIPS_TLS_DTPREL64 as static relocations in 
</I>&gt;<i> linker input files as well as dynamic relocations for the dynamic linker: 
</I>&gt;<i> when found in input files, the linker would resolve them in the obvious 
</I>&gt;<i> way to the offset for the TLS variable in the TLS area for the current 
</I>&gt;<i> module.  (The debug information is only generated for the object where the 
</I>&gt;<i> TLS variable is defined, so this is effectively the LD model and acts like 
</I>&gt;<i> a combinarion of the _HI16 and _LO16 relocations used for that model.)  
</I>&gt;<i> Does anyone see problems with using these relocations this way, or think 
</I>&gt;<i> we should allocate two new relocations for this purpose instead?
</I>&gt;<i>   
</I>
Seems reasonable to reuse R_MIPS_TLS_DTPREL32 and R_MIPS_TLS_DTPREL64,
since AFAICS those relocs are currently generated only by the linker and
otherwise shouldn't be seen in a linker input file. What do other
architectures do here?


Nigel

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000050.html">DTPREL relocations in input files
</A></li>
	<LI>Next message: <A HREF="000052.html">[mips-tls] DTPREL relocations in input files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51">[ date ]</a>
              <a href="thread.html#51">[ thread ]</a>
              <a href="subject.html#51">[ subject ]</a>
              <a href="author.html#51">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://sourcerytools.com/cgi-bin/mailman/listinfo/mips-tls">More information about the mips-tls
mailing list</a><br>
</body></html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> DTPREL relocations in input files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mips-tls%40codesourcery.com?Subject=Re%3A%20DTPREL%20relocations%20in%20input%20files&In-Reply-To=%3CPine.LNX.4.64.0706062103470.23904%40digraph.polyomino.org.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000051.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>DTPREL relocations in input files</H1>
    <B>Joseph S. Myers</B> 
    <A HREF="mailto:mips-tls%40codesourcery.com?Subject=Re%3A%20DTPREL%20relocations%20in%20input%20files&In-Reply-To=%3CPine.LNX.4.64.0706062103470.23904%40digraph.polyomino.org.uk%3E"
       TITLE="DTPREL relocations in input files">joseph at codesourcery.com
       </A><BR>
    <I>Wed Jun  6 21:17:24 UTC 2007</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000051.html">[mips-tls] DTPREL relocations in input files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50">[ date ]</a>
              <a href="thread.html#50">[ thread ]</a>
              <a href="subject.html#50">[ subject ]</a>
              <a href="author.html#50">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The MIPS TLS specification has R_MIPS_TLS_DTPREL32 and R_MIPS_TLS_DTPREL64 
as relocations generated by the static linker and resolved by the dynamic 
linker.  (For those of you reading the document at 
&lt;<A HREF="http://www.linux-mips.org/wiki/NPTL">http://www.linux-mips.org/wiki/NPTL</A>&gt;, what appear there as 
R_MIPS_TLS_DTPOFF32 and R_MIPS_TLS_DTPOFF64 got renamed as part of merging 
the changes into FSF binutils, and the document hasn't been updated since 
then; see notes on changes at 
&lt;<A HREF="http://gcc.gnu.org/ml/gcc-patches/2005-03/msg00959.html">http://gcc.gnu.org/ml/gcc-patches/2005-03/msg00959.html</A>&gt;.)

While there are DTP-relative relocations R_MIPS_TLS_DTPREL_HI16 and 
R_MIPS_TLS_DTPREL_LO16, used together to generate an offset for a 
thread-local variable, there is no single relocation representing the 
offset.  This causes problems generating debug information for such a 
variable; instead of

  DW_OP_addr %dtprel(variable)
  DW_OP_GNU_push_tls_address

much more complicated code is needed to describe the offset

  DW_OP_addr %dtprel_hi(variable)
  DW_OP_addr %dtprel_lo(variable)
  DW_OP_const1u 16
  DW_OP_shl
  DW_OP_const1u 16
  DW_OP_shra
  DW_OP_swap
  DW_OP_const1u 16
  DW_OP_shl
  DW_OP_plus
  DW_OP_GNU_push_tls_address

(for 32-bit, similar for 64-bit) - this does work and allow the debugger 
to use the variables, but is not very efficient.  It seems reasonable to 
allow R_MIPS_TLS_DTPREL32 and R_MIPS_TLS_DTPREL64 as static relocations in 
linker input files as well as dynamic relocations for the dynamic linker: 
when found in input files, the linker would resolve them in the obvious 
way to the offset for the TLS variable in the TLS area for the current 
module.  (The debug information is only generated for the object where the 
TLS variable is defined, so this is effectively the LD model and acts like 
a combinarion of the _HI16 and _LO16 relocations used for that model.)  
Does anyone see problems with using these relocations this way, or think 
we should allocate two new relocations for this purpose instead?

-- 
Joseph S. Myers
<A HREF="http://sourcerytools.com/cgi-bin/mailman/listinfo/mips-tls">joseph at codesourcery.com</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000051.html">[mips-tls] DTPREL relocations in input files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50">[ date ]</a>
              <a href="thread.html#50">[ thread ]</a>
              <a href="subject.html#50">[ subject ]</a>
              <a href="author.html#50">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://sourcerytools.com/cgi-bin/mailman/listinfo/mips-tls">More information about the mips-tls
mailing list</a><br>
</body></html>
